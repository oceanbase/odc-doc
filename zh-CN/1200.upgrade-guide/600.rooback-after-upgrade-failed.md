# 升级失败回滚

升级 Web 版 ODC 后，如果发现升级后的版本有严重的问题，您可以回滚基于备份的元数据库并启动之前版本的镜像。

1. 停止新版 ODC 服务。

   a. 获取容器 ID。

      ```javascript
      C:\Users\ob>docker ps -a
      CONTAINER ID        IMAGE                                      COMMAND                  CREATED             STATUS              PORTS                                      NAMES
      8bfecbc1cd03        acs-reg.alipay.com/oceanbase/obodc:2.0.1   "/bin/sh -c '/usr/bi..."   13 days ago         Up 13 days          80/tcp, 8080/tcp, x.x.x.x:8989->8989/tcp   obodc
      ```
    b. 停止运行新版本 ODC 的容器。

      ```javascript
      C:\Users\ob>docker stop 8bfecbc1cd03
      8bfecbc1cd03
      ```
2. 恢复升级前版本的元数据库。

    示例：使用升级前备份的元数据库文件 `~/odcmetadb_backup` 恢复 ODC 元数据库。

    ```shell
    #restore odc metadb
    ./obloader --thread 1 -h <host> -P <port> -u <username> -c <cluster_name> -t <tenant_name> -D <database_name> --ddl --csv --no-sys --all -f ~/odcmetadb_backup
    ```

    <main id="notice" type='explain'>
       <h4>说明</h4>
       <ul>
       <p>恢复使用的参数说明请参见 <a href="https://www.oceanbase.com/docs/enterprise-oceanbase-dumper-loader-cn-1000000000076572">OBLOADER 命令行选项</a>。</p>
    </main>
<br>
3. 启动升级前版本的 ODC 服务。

   ```javascript
   #!/usr/bin/env bash
   docker run -d -i --net host --cpu-period 100000 --cpu-quota 400000 --memory 8G --name "obodc"
   -e "DATABASE_HOST=xxx.xx.xx.xx"
   -e "DATABASE_PORT=60805"
   -e "DATABASE_USERNAME=obodc@obodc#odc_cluster"
   -e "DATABASE_PASSWORD=obodc"
   -e "DATABASE_NAME=odc_metadb"
   -e "ODC_PROFILE_MODE=alipay"
   reg.docker.alibaba-inc.com/oceanbase/odc-server:{image_tag}
   ```

   其中，{image_tag} 可以在宿主机上加载镜像后运行 `docker images` 语句查看，其它参数说明如下表所示：


   |  参数 | 说明  |
   |---------------------------|---------------------------------|
   | --net                     | 指定容器的网络配置，指定该参数值为 `host` 即直接使用宿主机网络。 您也可以使用 `--publish`（`-p`）参数配置端口映射，但是部分环境可能出现因为 Docker 内 DNS 解析出错而启动容器失败，此时请使用 `--net host` 方式启动 Docker。                                                                |
   | --cpu-period  --cpu-quota | ---cpu-period 用来指定容器对 CPU 的使用要在多长时间内做一次重新分配。单位为微秒。 ---cpu-quota 用来指定在这个周期内，最多可以有多少时间用来运行当前容器。单位为微秒。 配合使用可指定容器使用的 CPU 核数。cpu-quota/cpu-period 的值即为 Docker 可以使用的 CPU 核数，示例语句中 400000/100000=4 表示最多可以使用 4 个核。 |
   | --memory                  | 设置容器使用的内存最大值。   |
   | --name                    | 指定容器名称。 |
   | DATABASE_HOST             | 元数据库 IP 地址。 |
   | DATABASE_PORT             | 元数据库端口号。   |
   | DATABASE_USERNAME         | 元数据库用户名，OceanBase 数据库用户名的格式为 db_user@tenant_name#cluster_name。 |
   | DATABASE_PASSWORD         | 连接数据库的用户名。  |
   | DATABASE_NAME             | 元数据库名。 |
   | ODC_PROFILE_MODE          | 指定模式，默认指定为 `alipay`。 |
