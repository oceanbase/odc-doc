本文描述 ODC WEB 版日志路径和查看方式。
> ODC 桌面版日志查看可参考 《[查看  ODC Windows Mac 桌面版日志](https://yuque.antfin-inc.com/obodc/troubleshoot/onf34zq1t4y7p2z0)》。


<a name="JdvQm"></a>
# ODC WEB 版日志目录和文件说明
日志目录：docker 内 `/opt/odc/log/` 

登录宿主机，执行以下命令进入 ODC Docker
```shell
# 查看 odc docker image name
docker ps -a --format "{{.Names}}" | grep odc

# 进入 odc docker，假设 docker image name 为 odc
IMAGE_NAME=odc &&
docker exec -it ${IMAGE_NAME} sh
```

日志文件说明
```shell
cd /opt/odc/log

sh-4.2# ls -l
total 540
-rw-r--r-- 1 root root   9062 May 13 15:23 gc.log.0.current
-rw-r--r-- 1 root root 523802 May 13 15:23 odc.log
```

- odc.log 是 odc-server 的应用程序日志
- gc.log 是 odc-server 的 JVM GC 日志
<a name="WL00E"></a>
# 根据 HTTP 请求定位后端日志

<a name="qdZcx"></a>
## 步骤1. 浏览器开启调试（快捷键 F12）
以 Chrome  浏览器为例，选择 Network Tab，选择 XHR 过滤 AJAX 请求。<br />![查看 ODC 日志-根据 HTTP 请求定位后端日志-1.png](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/28156339/1651756531845-61d31b1b-f030-4cba-a2ad-e2bce91e22cf.png#clientId=ua8745637-3fe3-4&from=ui&id=u5ef8923e&originHeight=758&originWidth=1924&originalType=binary&ratio=1&rotation=0&showTitle=false&size=60729&status=done&style=none&taskId=u88847922-26df-4f12-8528-08fba9122bd&title=)
> 说明：ODC 为前后端分离架构，页面和数据是分离状态，因此 ODC 前端和后端的交互数据均通过 AJAX 请求实现。

<a name="JIKYM"></a>
## 步骤2. 执行操作，观察请求的 Response
![image.png](https://intranetproxy.alipay.com/skylark/lark/0/2021/png/188311/1622537953593-6c2944fa-898e-4eaa-a7dc-efc62a9ed67a.png#clientId=u7f392601-0161-4&from=paste&height=613&id=kwlxp&originHeight=613&originWidth=961&originalType=binary&ratio=1&rotation=0&showTitle=false&size=69824&status=done&style=stroke&taskId=u9746f464-689c-47a9-ba1b-533d5c995a5&title=&width=961)<br />所有 API 请求的 response 中都包含以下字段

- requestId，前端生成的 ID，会包含在后端日志中
- server，后端返回的服务器名称，在多节点部署场景下，用于确定处理当前请求的服务器
- timettamp，后端处理当前请求的时间戳
- traceId，后端生成的随机串，每个请求对应一个唯一的 traceId

<a name="ZmnlG"></a>
## 步骤3. 根据 traceId 检索后端日志文件
如上图所示的样例

- 去主机名称为 OceanBase152084.et15sqa 的服务器检索日志
- 检索关键字为 `9a00e136324c43ac`

日志检索效果
```shell
grep 9a00e136324c43ac /opt/odc/log/odc/log
[2021-06-01 16:57:40.305][http-nio-8989-exec-15][9a00e136324c43ac,,QRR97CNVYCB61IP8TBXCPX][INFO][com.alipay.odc.service.OdcConsoleService][56]: sql is executed completely. executeSql=select * from dual;,duration=62(ms)
[2021-06-01 16:57:40.305][http-nio-8989-exec-15][9a00e136324c43ac,,QRR97CNVYCB61IP8TBXCPX][INFO][com.oceanbase.odc.web.trace.TraceOdcResultResponseAdvice][71]: ODC_REQUEST_TRACE, method=POST, URI=http://100.81.152.84:8989/api/v1/console/sql-execute/sid:62-5:d:yizhou_odc_240?ignoreError=true, client=10.15.228.247, userId=1000100, result=OdcResult(errCode=null, errMsg=ErrorCode: 1096, No tables used, isImportantMsg=false, timestamp=2021-06-01T16:57:40.242+08:00, durationMillis=63, traceId=9a00e136324c43ac, server=OceanBase152084.et15sqa, requestId=QRR97CNVYCB61IP8TBXCPX), userAgent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.212 Safari/537.36
```
<a name="pONDV"></a>
## 包含错误提醒的日志检索过程样例
这里尝试获取一个非法语句的执行计划，会失败<br />![image.png](https://intranetproxy.alipay.com/skylark/lark/0/2021/png/188311/1622538546590-e9660102-9509-45e3-9f04-6d7391bf8907.png#clientId=u7f392601-0161-4&from=paste&height=690&id=IXAAO&originHeight=690&originWidth=1199&originalType=binary&ratio=1&rotation=0&showTitle=false&size=89415&status=done&style=stroke&taskId=u87afbf2d-7888-4b8f-b99f-31dadc8703f&title=&width=1199)

错误日志
```shell
$grep 87d4f19ffcbd47cf /opt/odc/log/odc.log | grep ODC_FAILED_REQUEST | grep rootReason
[2021-06-01 17:08:38.743][http-nio-8989-exec-17][87d4f19ffcbd47cf,,QRR97CNVYCB61IP8TBXCPX][INFO][com.alipay.odc.controller.GlobalExceptionHandler][180]: ODC_FAILED_REQUEST, requestURI=/api/v1/diagnose/explain/sid:62-5:d:yizhou_odc_240, remoteHost=10.15.228.247, clientAddress=10.15.228.247, result=OdcResult(errCode=ObGetPlanExplainFailed, errMsg=获取执行计划失败，可能是语法错误或者 DDL 语句，错误详情：No tables used, isImportantMsg=false, timestamp=2021-06-01T17:08:38.738+08:00, durationMillis=4, traceId=87d4f19ffcbd47cf, server=OceanBase152084.et15sqa, requestId=null), exceptionType=ObException, message=No tables used, rootReason=com.alipay.odc.odcsdk.sdk.resourcedialect.exception.ObException: 获取执行计划失败，可能是语法错误或者 DDL 语句，错误详情：No tables used at com.alipay.odc.odcsdk.sdk.resourcedialect.exception.ObException.executeFailed(ObException.java:51)

```
注意包含 ODC_FAILED_REQUEST 关键字的日志行，提供了 **rootReason** 信息，这个信息对于开发定位问题非常有帮助（包含异常代码行）

- `**rootReason**=com.alipay.odc.odcsdk.sdk.resourcedialect.exception.ObException: 获取执行计划失败，可能是语法错误或者 DDL 语句，错误详情：No tables used at com.alipay.odc.odcsdk.sdk.resourcedialect.exception.ObException.executeFailed(ObException.java:51)`

对于预期外异常，ODC 日志还会包含完整的异常栈，样例如下：
```shell
[2021-03-08 17:05:42.675][http-nio-8989-exec-4][ERROR][com.alipay.odc.odcsdk.sdk.resourcedialect.command.sql.ExecuteSqlOneByOneCommand][139]:fail to recognize sql type, sql = flashback table odc_myapp20183253223_238930.__recycle_$_3_1613445194315049880 to before drop
com.alibaba.druid.sql.parser.ParserException: syntax error, error in :'back table odc_myapp20183253223_238', expect IDENTIFIER, actual IDENTIFIER pos 9, line 1, column 10, token IDENTIFIER null
        at com.alibaba.druid.sql.parser.SQLParser.printError(SQLParser.java:344) ~[druid-1.1.23.jar!/:1.1.23]
        at com.alibaba.druid.sql.parser.SQLStatementParser.parseStatementList(SQLStatementParser.java:532) ~[druid-1.1.23.jar!/:1.1.23]
        at com.alibaba.druid.sql.parser.SQLStatementParser.parseStatementList(SQLStatementParser.java:171) ~[druid-1.1.23.jar!/:1.1.23]
        at com.alipay.odc.odcsdk.sql.OdcSqlParser.parseStatements(OdcSqlParser.java:99) ~[ob-odc-sdk-2.4.0-SNAPSHOT.jar!/:?]
        at com.alipay.odc.odcsdk.sql.OdcSqlParser.<init>(OdcSqlParser.java:36) ~[ob-odc-sdk-2.4.0-SNAPSHOT.jar!/:?]
        at com.alipay.odc.odcsdk.sdk.resourcedialect.command.sql.ExecuteSqlOneByOneCommand.recognizeSqlType(ExecuteSqlOneByOneCommand.java:130) [ob-odc-sdk-2.4.0-SNAPSHOT.jar!/:?]
        at com.alipay.odc.odcsdk.sdk.resourcedialect.command.sql.ExecuteSqlOneByOneCommand.doExecute(ExecuteSqlOneByOneCommand.java:109) [ob-odc-sdk-2.4.0-SNAPSHOT.jar!/:?]
        at com.alipay.odc.odcsdk.sdk.resourcedialect.command.sql.ExecuteSqlOneByOneCommand.doObMysql(ExecuteSqlOneByOneCommand.java:114) [ob-odc-sdk-2.4.0-SNAPSHOT.jar!/:?]
        at com.alipay.odc.odcsdk.sdk.resourcedialect.command.sql.ExecuteSqlOneByOneCommand.doObMysql(ExecuteSqlOneByOneCommand.java:27) [ob-odc-sdk-2.4.0-SNAPSHOT.jar!/:?]

```

<a name="WO8ej"></a>
## 日志查看分析常用命令参考
```shell
# 查看最近10次错误请求
grep ODC_FAILED_REQUEST /opt/odc/log/odc.log | tail -10

# 根据 traceId 查看错误日志上下文，向前向后5行
#  -B, --before-context=NUM  print NUM lines of leading context
#  -A, --after-context=NUM   print NUM lines of trailing context
grep 87d4f19ffcbd47cf /opt/odc/log/odc.log -A 5 -B 5

```

