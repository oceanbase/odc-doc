Web 版 ODC 启动后无法访问 
======================================

问题现象 {#3369bbf000x0p}
---------------------

应用启动一段时间后，无法访问 Web 版 ODC 地址。

问题原因 
-------------------------

{#a81dbde0fbscn}{#919f8859fb9x2}{#d72e6300fb7ir}{#919faf65fbz0k}

|------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **报错信息**                           | **常见原因**                                                                                                                                                                                                                  |
| 应用无法连接元数据库导致启动失败                   | * MetaDB 配置错误。例如：密码错误。 {#cff15c00fbvp5} {#cff098b1fbrvl} * MetaDB 所在集群参数未开启 prepare statement。 {#cff15c01fbp82} {#a7f03ab1fb9m4} * MetaDB 所在租户白名单配置未包含 ODC 所在机器 IP 地址。 {#cff18310fbsnb} {#a7f03ab2fbbok} {#cff098b0fbnzz} |
| 升级执行数据迁移失败                         | ODC V3.2.0 之前的版本升级到更高版本时，存在已有的 admin 账号名称冲突。                                                                                                                                                                              |
| 容器化部署场景下由于宿主机 Docker 的网络设定错误导致无法访问 | * Docker 启动网络参数配置端口映射，但 Docker 内 DNS 寻址故障 {#12669aa0fbnua} {#161a05b0fbgma} * 可通过修改 docker run 网络参数为 --net host启动 Docker。 {#12669aa1fb6xf} {#17cb5f30fbvpj} {#161a05b2fbipi}                                              |

{#919f8850fbx9s}

解决方法 {#ccabd35000p83}
---------------------

查询 ODC 日志 `odc.log`。

### 无法连接元数据库 

此问题可能因用户在启动参数中填写错误元数据库的信息导致的：元数据库的 endpoint 错误或者元数据库的账户密码错误。

具体原因需要根据 ODC 的日志来判断。通常，由于元数据库因素导致的启动失败会在日志中发现如下打印，关键字为：`Could not connect to address` **。** {#19c55da0fbbln}

![image..png](../images/p675132.png)

用户需要对启动参数中的元数据库信息做逐一检查，建议通过 OBClient 在 ODC 的部署环境中进行实际连接测试，确保元数据库连接信息无误。

#### **docker run 参数小技巧** {#ebaaed70fbkwk}

使用 docker run 启动 odc-server docker 时，需要通过 -e设置环境变量值，该变量值可以使用 export命令设置后在 docker run 中直接引用，或者直接设置在 docker run -e 参数列表中。{#eda2ece0fbgya}

推荐使用 export命令设置后在 docker run 中直接引用的方式，因为{#f2f00ac0fbueg}

* 密码字段通常会包含特殊字符，如包含 $$ 符号，在 shell 中会被解析为进程号导致含义出错， docker run 中引用变量值可避免该问题。

  {#f2f00ac3fb4sx}
{#u19ab932c}
* 更安全，避免在宿主机通过 ps 命令显示 MetaDB 连接信息。

  {#f2f00ac4fbv8p}
{#u79ff53e5}

{#f2f00ac2fb5an}

示例：使用 export命令设置后在 docker run 中直接引用。{#f2f031d0fb2hg}

```shell
#创建 metadb，配置启动参数配置
export DATABASE_HOST=***
export DATABASE_PORT=***
export DATABASE_NAME=***
export DATABASE_USERNAME=***
export DATABASE_PASSWORD=***

# 启动 odc-server docker
ODC_DOCKER_NAME="odc-server" &&
MEMORY_LIMIT=8G &&
docker run -d -it --name ${ODC_DOCKER_NAME} --network host \
 --cpu-period 100000 --cpu-quota 400000 --memory=${MEMORY_LIMIT} \
 -e PROFILE_MODE -e DATABASE_HOST -e DATABASE_PORT -e DATABASE_NAME \
 -e DATABASE_USERNAME -e DATABASE_PASSWORD \
 ${ODC_DOCKER_IMAGE_ID}
```

{#7vr7il}

### **升级执行数据迁移失败** {#dy9cA}

#### **3.1.x 之前的版本升级到 3.2.0 及之后的版本，内置 admin 账号名称冲突** {#61deac60fbk14}

为避免账号冲突，ODC 启动时会进行预检查，如果存在内置账号名称冲突则需要将之前版本冲突的账号重命名。

1. 查看odc.log确认具体的出错位置。日志关键字可能为下述一种：{#a54a31e1fb4wt}

   * Failed to migrate users

     {#a54a31e6fbc4q}
   {#eddb9e31fba3o}
   * Renamed account name conflicts

     {#f7029ae0fbpru}
   {#f702c1f0fbnif}
   * Failed to migrate odc users

     {#f80df060fbwzj}
   {#f80e1770fb56c}
   * Duplicated account name

     {#fa1fb960fbx61}
   {#fa1fe070fbyuz}

   {#ee7fa661fbicu}

   ![image..png](../images/p675134.png)
   {#0b2972f0fbce9}
{#b3c6d7f0fbskv}
2. 在日志中查询 ODC 生成的rename.properties文件路径，该文件用于对系统中的同名 admin 用户进行更名。{#30c60cd0fbsb9}

   ```shell
   [2022-03-23 20:15:31.837][main][,,][ERROR][com.alipay.odc.metadb.alipay.V3202BuiltInResourceMigrate][103]: Failed to migrate odc users, the reason is that the account name and the reserved account have the same name, reservedAccountNames=admin, renameFile=/Users/yh263208/oceanbase/odc/ob-odc/app/odc-web-starter/target/classes/static/tmp/rename.properties
   ```

   {#brubty}{#23be2c70fbenx}
{#23be2c70fbenx}
3. 查看rename.properties文件内容。{#aa292f30fbc4v}

   ```plaintext
   #Please enter the rename of the conflicting account name here
   #Wed Mar 23 20:15:31 CST 2022
   admin=
   ```

   {#wkqblv}{#aa292f31fb18g}
{#aa292f31fb18g}
4. 将新的账户名填写在冲突名称之后，再重启 ODC 应用。

   {#86f27c50fbwvw}
{#23b66ed1fbzpc}

{#b3c6d7f2fbndy}

#### **升级时 MetaDB 数据迁移出错** {#LfRxU}

如果不是内置账号名称冲突导致的数据迁移失败，则需要根据迁移历史和日志做进一步分析。{#d2cc83f0fbguv}

1. 连接到 ODC 的 MetaDB，确定应用的升级是否成功。{#d7a905b0fbdth}

   ODC 的元数据库 migrate_schema_history表记录了应用的升级历史，可以检查最新一条记录的success是否为1，如果是则证明应用升级成功，否则证明升级失败。{#e81790b0fbld4}

   查询参考语句：{#b72d5420fbixs}

   ```sql
   -- 按照版本号和执行脚本聚合查询，原始的记录数量可能因为反复尝试重新运行失败的脚本而较多
   select version, script, success, max(install_rank) as install_rank
   from migrate_schema_history
   group by version, script, success
   order by install_rank desc;
   ```

   {#9hwilf}{#e497dfd0fb5c6}
{#e497dfd0fb5c6}
2. 检查日志，根据odc.log中的报错信息确定具体的升级失败原因。

   {#cab0e750fbjge}
{#c5dd1821fbcyg}

{#e497dfd2fb7ix}

### Docker 网络设置问题 

如果是通过 Docker 技术部署 ODC 应用，需要排查 Docker 的网络设置是否正确。在 ODC 部署手册中有 2 种网络模式以供选择：

* host 模式，这种模式将复用宿主机的网络，用户无需进行任何网络设定即可使用。

  
{#09685aa0fbffo}
* 对相应的网络端口映射，以保证 ODC 和外界的网络通信。

  {#0f0f3140fbth5}
{#0f0f5850fb0ym}

{#09685aa2fb4pv}
