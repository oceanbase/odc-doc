如何调试存储过程 
=============================

本篇教程介绍在 OceanBase 开发者中心（OceanBase Developer Center，ODC）中调试一个存储过程的详细步骤。

背景信息 
-------------

PL 程序的开发工作是数据库服务开发人员重要的日常工作，与 SQL 语句的支持模块类似，PL 的调试模块同样为非常重要的功能。因此，在编程过程中，开发人员需要一个PL 开发区域和调试功能。

ODC V2.2.0 及之后版本支持 PL 对象和匿名块的创建、编译、运行和调试等功能。您可在匿名块窗口的编辑区域中编译 PL 语句，同时可对已创建的 PL 对象进行编辑和调试等操作。针对 PL 对象的调试，ODC 提供批量执行、单步执行、跳入、跳出、终止调试、重新调试和退出调试等功能，同时提供 **参数** 、 **堆栈和变量** 、 **DBMS 输出** 、 **断点** 、 **调试日志** 等页签查看调试产生的信息。

前提条件 
-------------

* 调试功能只支持 V2.2.73 及之后版本的 OceanBase 数据库 Oracle 模式。

  

* ODC V3.2.2 之前版本，通过 OBProxy 连接至目标实例时无法使用调试功能，请在 ODC 中直连到目标实例。

  

* 自 ODC V3.2.2 及之后版本，ODC 支持通过 OBProxy 连接 OBServer 情况下进行 PL 调试。

  

* 在调试前，请确保连接的数据库中已安装 DBMS_DEBUG 和 DBMS_OUTPUT 等调试包。

  

* 按下述示例脚本创建示例存储过程 procedure_test：

  ```javascript
  CREATE OR REPLACE PROCEDURE procedure_test
  (
      A IN NUMBER,
      B IN NUMBER,
      C OUT NUMBER
  ) IS
  BEGIN
      C:= A + B;
      dbms_output.put_line ( C / 2  ) ;
  END procedure_test;
  ```

  




操作步骤 
-------------

存储过程 procedure_test 的结果是输出参数 C 除以 2 后的值，参数 C 的值等于参数 A 加参数 B，因此在程序运行后通过输出结果无法直接看到参数 C 的值。通过调试存储过程 procedure_test 可查看和验证参数 C 在程序运行中实际的值。

1. 进入调试模式。

   进入连接后，在左侧的存储过程列表中查找目标存储过程 procedure_test 右键其名称，在弹出的列表中单击 **调试** 按钮开始调试（或可在列表中先单击 **编辑** 按钮进入对象编辑页面，在编辑页面的工具栏中单击调试图标![调试](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/9338438361/p361384.jpg)开始调试）。
   

2. 设置参数。

   存储过程 procedure_test 中包含三个参数，A 和 B 为输入参数，C 为输出参数。
   1. 存在输入参数时，在调试时需首先设置参数的值。因此开始调试时，ODC 会首先弹出 **设置参数** 页面，请在该页面为输入参数赋值：指定参数 A 的值为 2，参数 B 的值为 4。

      
   
   2. 输入值后单击 **确定** ，完成参数设置。

      ![Image 223](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/4256904161/p242630.png)
      
   

   

3. 进入调试页面。

   参数设置完成后，即可进入调试页面。

   调试页面编辑区下的 **参数** 页签显示该程序在运行前设置的所有的参数定义信息（参数名、模式和类型）及对应的值，其中对应的值会根据调试过程作出相应的变化。

   在调试页面的工具栏中 ODC 提供了以下功能键：
   * **批量执行** ：批量运行至最近断点，若无断点直接运行至结尾语句。

     
   
   * **单步执行** ：单步执行，不会进入子程序。

     
   
   * **跳入** ：单步执行，若当前行是调用已定义的存储程序或函数，则会进入被调用的子程序。

     
   
   * **跳出** ：在子程序内，执行跳出操作后，返回到上层调用位置的下一行；主程序内运行跳出，效果和 **自动调试** 相同。

     
   
   * **终止调试** ：继续运行直到结束，会跳过后续设置的断点。

     
   

   

4. 设置断点。

   设置断点用于在程序运行时中断在所需位置，从而方便分析程序。在 ODC 中通过单击编辑区中的行号设置断点：
   1. 请在示例程序中，单击第 9 行语句 `dbms_output.put_line ( C / 2 );` 的行号，设置一个断点；

      
   
   2. 在编辑区下的 **断点** 页签中，会展示在程序中所有设置的断点的 PL **对象名称** 和 **行号** 等信息，同时提供 **取消** 和 **查看** 断点操作。

      **说明**

      

      内核不支持在注释行和 begin、end 等关键字行处设置断点。
      
   

   

5. 开始调试。

   设置完断点后，单击工具栏中的批量执行图标![调试-批量执行](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/9338438361/p361401.jpg)，程序将按步骤开始执行并在断点处终止。或可单击单步执行图标![调试-单步执行](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/0438438361/p361403.jpg)（单击一次单步执行，程序向后执行一步）。
   

6. 查看调试信息。

   程序此时终止在第 9 行，可在编辑区下的 **堆栈和变量** 页签查看当前栈上的变量与其对应的值。因设置断点，程序此时终止在了第 9 行，所以在 **堆栈和变量** 页签显示变量 C 的值为 6。在 **调试日志** 页签中可查看调试开始、调试结束、断点添加、断点取消等操作的记录和错误日志。
   

7. 终止调试。

   单击工具栏中终止调试图标![调试-终止调试](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/0438438361/p361412.jpg)后，程序将继续运行至结束并跳过后续设置的断点。

   因程序中包含 PL 输出语句 `dbms_output.put_line`，所以当程序运行结束后，在编辑区下的 **DBMS 输出** 页签中会显示输出结果参数 C 除以 2 的值。此时页签中显示值 3，说明程序执行无误。
   

8. 重新调试。

   运行结束后，如需对当前对象再次发起新一轮的调试，可单击工具栏中的 **重新调试** 按钮。此时上一轮调试运行后的信息与断点将被清空，可再次进行设置并开始调试。
   

9. 退出调试。

   当通过调试已完成程序的分析后，可单击工具栏中的 **退出调试** 按钮以退出调试页面。
   



