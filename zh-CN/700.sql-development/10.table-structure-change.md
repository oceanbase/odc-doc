# 新建无锁结构变更

## 背景信息

为解决变更数据库表结构时的锁表问题，ODC V4.2.0 版本提供了无锁结构变更功能，该功能可以较好地规避因锁表以致于阻塞业务。

本文档旨在介绍如何通过提交无锁变更工单实现数据库无锁结构变更。

ODC 支持的在线结构变更：

| 支持的版本 | 说明 |
| ------ | ------ |
|OceanBase V3.2.3 及之后的版本 | <ul><li>  新增列，不支持新增主键列。</li><li>  修改列属性，包括列名称、类型、默认值、非空约束。</li><li>  删除列，不支持删除主键列或者包含索引的列。</li><li>  非分区表中增加唯一索引。</li><li>  重命名表。</li><li>  增加或删除外键。</li><li>  修改表的副本数。</li><li>  更改表的表组。</li></ul> |
|OceanBase V3.2.3 及之后的版本|<ul><li>  修改列为自增列。</li><li>修改强制类型/长度。</li><li>  添加/修改主键。</li></ul>|

## 前提条件

## 注意事项

- 目标表中包含主键或唯一键：在执行无锁结构变更时，主键或唯一键用于全量拷表分段操作及后续增量更新。

- 确保数据库磁盘空间充足。

- 执行无锁结构变更时，当前表不能包含其它 DDL。 

## 原理介绍


## 执行流程



1. 用户发起无锁结构变更工单。
2. 对用户输入的 SQL 语句进行预检查。
3. 审批任务流程。
4. 执行无锁结构变更任务。

## 操作步骤

示例：将表 employee 中的列 emp_no 设置为主键。

| 信息项 | 示例值 |
| ------ | ------ |
|项目名称 | odc_4.2.0 |
|所属数据源|mysql410 |
|数据库名称|odc_test|
|表名称|employee|

1. 在 **项目** > **全部项目** 页面中单击项目名称 **odc_4.2.0**。

   ![1](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/odc/420/quickstart/webodc/add%20database/1.png)

2. 在 **工单** 页签中单击 **无锁结构变更** > **新建无锁结构变更**。

   ![2]()

3. 在 **新建无锁结构变更** 页面中，输入以下信息。

   ![3]()

   |  信息项   |说明|
   |--------|-------|
   | 数据库    | 选择需变更的数据库。|
   | 变更定义 | <ul><li>CREATE TABLE：在表中新增列、主键、外键等 SQL 语句。</li></li>ALTER TABLE：对表中列属性、主键进行修改、修改表名称等 SQL 语句。</li></ul>    |
   | SQL 内容   | 在编辑区中直接录入 SQL 脚本。<blockquote>**说明**<ul><li>在 SQL 录入中，最大允许输入 500000 个字符，如超限可上传附件。</li><li>单击 **IN 值转化** 按钮，可将批量复制的数据转化成 in（'A','B'）格式。</li></li>列值分隔符号为换行符。</li></li>行值分隔符为空格或 TAB 值。</li></ul></blockquote>|
   | 切换表设置    | 数据一致后将原表切换为目标表。<ul><li>锁表超时时间：切换表过程会锁表，超时未切换完成可能导致执行失败。</li><li>失败重试次数：超过锁表时间后，未切换完成可自动重试。</li><li>完成后源表清理策略：选择 **重命名不处理**，重命名源表，不删除。选择 **立即删除**，无锁结构变更完成后删除源表。</li></ul>|
   |任务设置|<ul><li> 选择 **立即执行** / **定时执行** 设置任务执行方式。</li><li>无锁结构变更工具提供两种任务错误处理方式：<ul><li> **停止任务** ：停止任务为默认方式，运行脚本的过程中出现错误时会停止运行。</li><li> **忽略错误继续任务** ：选择忽略错误继续任务方式，在运行脚本出现错后将跳过错误语句继续执行。</li></ul></li></ul>|
   | 备注   | 可在 **备注** 文本框中输入不超过 200 个字符的描述信息，该项为选填项。|                                                    
3. 单击 **新建**，完成新建无锁结构变更。

4. 任务生成后可以在 **工单** > **无锁结构变更** 列表中查看任务信息。
    
    ![4]()

## 查看无锁结构变更任务

### 任务信息 

1. 在 **任务中心** 的无锁结构变更列表中，单击操作列中的 **查看** 按钮。

   ![5](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/odc/420/sql-development/database%20change/5.png)

2. 在弹出的任务详情面板中，单击 **任务信息** 页签查看所属数据库、任务类型、风险等级、SQL 内容和回滚内容等信息。

   ![6](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/odc/420/sql-development/database%20change/6.1.png)

3. 单击 **再次发起**，可重新发起无锁结构变更任务；单击 **回滚**，回滚数据。

### 任务流程 

![7](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/odc/420/sql-development/database%20change/7.png)

在任务详情面板中，单击 **任务流程** 页签查看发起任务状态、审批状态、执行状态和执行结果等信息。


### 执行结果 

![8](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/odc/420/sql-development/database%20change/8.png)

在任务详情面板中，单击 **执行结果** 页签查看 执行成功和执行失败记录。

## 回滚工单

在任务详情面板中，单击 **回滚工单** 查看任务


### 任务日志 

![9](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/odc/420/sql-development/database%20change/9.png) 

在任务详情面板中，单击 **任务日志** 页签查看任务的全部日志和告警日志。


| 信息项  |  说明  |
|---------|--------------|
| 全部日志 | 全部日志显示任务的 **INFO** 、 **ERROR** 和 **WARN** 日志等全量信息。 单击 **查找** 、 **下载** 和 **复制** 按钮，可查找信息、下载或复制全部日志信息。        |
| 告警日志 | 告警日志单独显示任务的 **ERROR** 和 **WARN** 日志。当任务失败时，可通过告警日志查看错误信息。 单击 **查找** 、 **下载** 和 **复制** 按钮，可查找信息、下载或复制告警日志信息。 |