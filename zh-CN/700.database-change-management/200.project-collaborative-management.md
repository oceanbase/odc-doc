# 项目协同管理

## 背景信息

Web 版 ODC V4.2.0 及之后的版本支持拥有创建项目权限的用户创建项目和添加项目成员，成员可以在项目中添加和变更数据库。

本篇文档旨在介绍如何通过项目协同实现数据库变更。

## 原理介绍

<img src="https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/odc/420/1100.database-change-management/1.project-collaborative-management/1.png" width="900">

1. ODC 系统管理员授予用户创建项目的角色后，该用户创建项目并添加项目成员。

2. 项目管理员/ DBA 成员添加数据库。

3. 项目普通成员发起工单，申请数据库变更。

4. ODC 根据风险等级识别规则判断出该工单的风险等级，执行该风险等级对应的审批流程。

5. 审批通过后，ODC 自动执行或者用户手动执行数据库变更。

## 创建项目

### 方法一：拥有创建项目角色的用户创建项目

1. 系统管理员授予给用户创建项目的权限。

   <img src="https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/odc/420/1100.database-change-management/1.project-collaborative-management/2.png" width="900">

2. 项目管理员创建项目并添加项目成员。

   <main id="notice" type='explain'>
      <h4>说明</h4>
      <p>拥有创建项目权限的 ODC 用户可以创建项目。默认情况下，项目创建者被授予该项目管理员角色。项目管理员通过在项目中配置 ODC 所属的用户为该项目的成员后，项目成员可以在使用自己的账号登录 ODC 时访问该项目，并在同一个项目中进行团队协作。</p>
   </main> 

   <img src="https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/odc/424/700.database-change-management/200.project-collaborative-management/3.0.png" width="900">

   |信息项|说明|
   |-------------|--------------|
   | 项目名称        | 创建的项目名称。 |
   | 管理员        | 支持管理项目所有数据库和成员。  |
   | DBA        | 支持管理项目所有数据库。|
   |  开发者       | 允许登录所有数据库、执行 SQL、提交工单，通常是开发人员。   |
   |安全管理员（可选）|只允许管理项目的敏感列和参与审批。|
   |参与者（可选）|只允许参与审批。|
   |描述（可选）|非必填项。|

### 方法二：加入项目

ODC 用户可以通过 **申请项目权限** 加入已创建的项目。

1. 在 **项目**/**工单** 中，单击 **申请项目权限**。

   a. 通过项目入口申请。

      <img src="https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/odc/423/700.database-change-management/200.project-collaborative-management/3.1.png" width="900">

   b. 通过工单入口申请。

      <img src="https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/odc/430/700.database-change-management/200.project-collaborative-management/3.2.png" width="900">

2. 选择项目、项目角色并输入申请原因后，单击 **新建**，创建项目权限申请。

   <img src="https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/odc/431/700.database-change-management/200.project-collaborative-management/3.3.png" width="900">

3. 在工单中查看审批状态。

   <img src="https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/odc/423/700.database-change-management/200.project-collaborative-management/3.4.png" width="900">

4. 审批通过后，可以在项目列表中查看已加入的项目。

   <img src="https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/odc/423/700.database-change-management/200.project-collaborative-management/3.5.png" width="900">

## 数据库管理

### 方法一：拥有数据库权限的用户添加数据库

1. 单击项目名称，进入该项目管理页面。

   <img src="https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/odc/430/700.database-change-management/200.project-collaborative-management/4.png" width="900">

2. 在数据库页面中添加数据库。

   <img src="https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/odc/430/700.database-change-management/200.project-collaborative-management/5.png" width="900">

3. 项目成员可以导出/导入/数据库变更/登录数据库，且项目管理员/DBA 成员支持设置库管理员和修改所属项目。

   <img src="https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/odc/430/700.database-change-management/200.project-collaborative-management/6.0.png" width="900">

   <main id="notice" type='explain'>
     <h4>说明</h4>
     <p>如果数据源已绑定项目，数据源内的数据库不支持转移到其它项目中。</p>
   </main>

### 方法二：申请数据库权限

<main id="notice" type='notice'>
  <h4>注意</h4>
  <ul>
  <li>申请数据库权限，ODC 用户须确认已加入项目。</li>
  <li>ODC 用户仅支持申请已加入项目中的数据库权限。</li>
  </ul>
</main>

ODC 用户可以通过 **申请库权限** 以获取查询/导出/变更数据库权限。

1. 在 **项目**/**工单** 中，单击 **申请库权限**。

   a. 通过项目入口申请。

      <img src="https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/odc/430/700.database-change-management/200.project-collaborative-management/1database.png" width="900">

   b. 通过工单入口申请。

      <img src="https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/odc/430/700.database-change-management/200.project-collaborative-management/2database.png" width="900">

2. 选择项目、数据库、数据库权限类型、权限有效期并输入申请原因后，单击 **新建**，创建库权限申请。

   <img src="https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/odc/431/700.database-change-management/200.project-collaborative-management/3database.png" width="900">

## 逻辑库管理

ODC V4.3.2 及之后的版本支持将多个（或单个）物理库配置成一个逻辑库并配置逻辑表，以查询和管理复杂、庞大的分库与分表。

<main id="notice" type='explain'>
   <h4>说明</h4>
   <p>如无逻辑库权限，您可以通过项目/工单中的 <strong>申请库权限</strong> 申请逻辑库权限。</p>
</main>

### 逻辑库与物理库关系

<img src="https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/odc/432/700.database-change-management/200.project-collaborative-management/1logical.png" width="600">

1. ODC 支持将同一项目内，相同数据源类型和环境的多个（或单个）物理数据库配置为一个逻辑库。

2. 逻辑库配置完成后，ODC 会自动解析逻辑库，将逻辑库中表名前缀相同且表结构一致的物理表提取为一张逻辑表，同时生成逻辑表表达式。

   <main id="notice" type='explain'>
     <h4>说明</h4>
     <ul><li>如果物理表的表结构在逻辑库里是唯一的，将不会生成逻辑表。</li>
     <li>生成的逻辑表名默认为物理表名前缀字符串。例如，物理表名分别为<code>test_0</code>、<code>test_1</code>、<code>test_2</code> 和 <code>test_3</code>，则生成的逻辑表名为 <code>test</code>。逻辑表表达式为 <code>test_[0-3]</code>。具体请参见 <a href="[../../3.develop/4.replace-data-of-mysql-mode.md](https://help.aliyun.com/zh/dms/expressions-of-logical-tables?spm=a2c4g.11186623.0.0.7ff81ab7ToZrqX)">逻辑表表达式</a>。</li></ul>
   </main>

3. 逻辑表配置完成后，您可以对逻辑表配置分片策略，ODC 会根据您配置的分片策略进行条件定位查询，以快速查询指定物理表，免去人为计算、切换物理库表的操作。

   <main id="notice" type='explain'>
     <h4>说明</h4>
     <p>若未配置分片策略，则在对逻辑表的数据进行操作时，会遍历逻辑表对应的每一个物理表，整体操作时间会成倍增加，并且不能执行 INSERT 语句，因为此时不能确定应该去哪个物理表上执行。</p>
   </main>

   分片策略由路由 **字段+算法** 组成。您输入字段值后，ODC 会通过算法计算出物理表名。例如：

   - 简单取模：`#user_id#%100`，字段 `user_id`，算法 `mod 100`，得出来的结果范围是 `0-99`，即逻辑表的后缀。

   - 库名和表名：`'schema_prefix_'+(#user_id#%100)+'.table_name_prefix_'+(#user_id#%1000)`。

### 配置逻辑库

1. 单击项目名称，进入该项目管理页面。

   <img src="https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/odc/430/700.database-change-management/200.project-collaborative-management/4.png" width="900">

2. 在数据库页面中，单击 **配置逻辑库**。

   <img src="https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/odc/432/700.database-change-management/200.project-collaborative-management/2logical.png" width="900">

3. 在 **配置逻辑库** 页面，配置如下信息。

   <img src="https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/odc/432/700.database-change-management/200.project-collaborative-management/3logical.png" width="900">

   |信息项|说明|
   |-------------|--------------|
   | 基准库     | 选择一个数据库作为基准库，该数据库包含在逻辑库中，用于指定数据库环境和类型，ODC 可根据基准库的名称、环境、类型等信息筛选符合条件的数据库。 |
   | 逻辑库别名 |用于区分同名的逻辑库，默认与实际逻辑库名一致。逻辑库别名不可重复，支持修改。  |
   | 数据库|选择数据库。 |

4. 单击 **提交** 完成配置。

### 逻辑库列表

<img src="https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/odc/432/700.database-change-management/200.project-collaborative-management/4logical.png" width="1100">

您可以在数据库页签中查看配置的逻辑库列表。

在 **操作** 项下，您可以执行以下操作。

- 逻辑表管理：支持自动提取/手动新建逻辑表。

  <img src="https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/odc/432/700.database-change-management/200.project-collaborative-management/5logical.png" width="600">

- 创建逻辑库变更任务，具体操作请参见 [逻辑库变更管理](620.Logical-database-change.md)。
- 登录数据库，在 SQL 开发窗口管理数据库。
- 移除逻辑库。

## 表管理

项目成员可以申请项目中任何数据库下的表权限。

项目成员可以通过 **申请表权限** 以获取查询/导出/变更表权限。

<main id="notice" type='notice'>
  <h4>注意</h4>
  <ul><li>ODC 用户仅支持申请已加入项目中的表权限。</li>
  <li>如果表或者数据库转移到其它数据库或者项目，原有的表权限将会失效。</ul>
</main>

1. 在 **项目**/**工单** 中，单击 **申请表权限**。

   a. 通过项目入口申请。

      <img src="https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/odc/431/700.database-change-management/200.project-collaborative-management/0table.png" width="900">

   b. 通过工单入口申请。

      <img src="https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/odc/431/700.database-change-management/200.project-collaborative-management/2table.png" width="900">

2. 选择项目、表、权限类型、权限有效期并输入申请原因后，单击 **新建**，创建表权限申请。

   <img src="https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/odc/431/700.database-change-management/200.project-collaborative-management/3table.png" width="900">

3. 申请完成后，项目成员可以根据申请的权限类型对表进行管理。

   - 拥有表的查询权限：可在 SQL 窗口中执行该表的查询语句。
   - 拥有表的变更权限：可在 SQL 窗口中执行该表的变更语句。
   - 拥有表的导出权限：可发起该表的导出工单。
   - 拥有数据库的查询权限：可在 SQL 窗口中执行该数据库下的查询语句。
   - 拥有数据库的变更权限：可在 SQL 窗口中执行该数据库下的变更语句、发起除导出和导出结果集之外的工单。
   - 拥有数据库的导出权限：可发起数据库导出工单。
   - 拥有数据库的查询和导出权限：可发起导出结果集工单。

   相关操作请参见 [SQL 语句创建和管理表](../500.sql-development/100.sql-editing-and-execution.md)、[可视化方式创建和管理表](../500.sql-development/700.database-objects/100.web-odc-table-objects/200.web-odc-create-a-table.md) 和 [数据库变更管理](600.database-change.md)。

## 工单管理

无数据库编辑权限的项目普通成员可以通过工单申请执行导出数据/导入数据/模拟数据/数据库变更/无锁结构变更/SQL 计划/数据归档任务。

<img src="https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/odc/431/700.database-change-management/200.project-collaborative-management/7.png" width="900">

## 成员管理

项目管理员可以在成员页面中添加/编辑/移除成员，以及管理库/表权限。

<img src="https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/odc/431/700.database-change-management/200.project-collaborative-management/8.0.png" width="900">

## 消息通知

项目成员可以在消息通知页面中启用需要通知的工单事件类型和添加推送通道（钉钉/飞书/企业微信/自定义 webhook），当启用的工单事件发生变更时，ODC 会发送变更消息提示项目成员。配置方法请参见 [消息通知管理](../950.notification-management/100.overview.md)。

<img src="https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/odc/430/700.database-change-management/200.project-collaborative-management/9.png" width="900">

## 项目设置

项目管理员可以在设置页面中修改项目名称和归档项目。

<img src="https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/odc/430/700.database-change-management/200.project-collaborative-management/10.png" width="900">

## 相关文档

- [风险等级、风险识别规则与审批流程](../700.database-change-management/300.risk-level-risk-identification-rules-and-approval-process.md)

- [SQL 检查规范](../700.database-change-management/400.sql-check-specification.md)

- [SQL 窗口规范](../700.database-change-management/500.sql-window-specification.md)

- [创建数据源](../400.connection-management/100.create-a-personal-connection.md)

- [数据库变更管理](../700.database-change-management/600.database-change.md)

- [导入数据](../600.import-and-export/100.import-data.md)

- [导出数据](../600.import-and-export/200.export-data.md)

- [用户和角色](100.user-permission-and-management/100.odc-users-and-roles.md)

