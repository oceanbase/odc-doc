# 逻辑库变更管理

## 背景信息

ODC V4.3.2 及之后的版本支持对逻辑库中的数据进行变更。用户可以通过逻辑库变更任务运行耗时较高的 SQL 语句以避免语句执行超时。

<main id="notice" type='explain'>
   <h4>说明</h4>
   <p>如无逻辑库权限，您可以通过项目/工单中的 <strong>申请库权限</strong> 申请逻辑库权限。</p>
</main>

### 逻辑库与物理库关系

<img src="https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/odc/432/700.database-change-management/200.project-collaborative-management/1logical.png" width="600">

1. ODC 支持将同一项目内，相同数据源类型和环境的多个（或单个）物理数据库配置为一个逻辑库。

2. 逻辑库配置完成后，ODC 会自动解析逻辑库，将逻辑库中表名前缀相同且表结构一致的物理表提取为一张逻辑表，同时生成逻辑表表达式。

   <main id="notice" type='explain'>
     <h4>说明</h4>
     <ul><li>如果物理表的表结构在逻辑库里是唯一的，将不会生成逻辑表。</li>
     <li>生成的逻辑表名默认为物理表名前缀字符串。例如，物理表名分别为<code>test_0</code>、<code>test_1</code>、<code>test_2</code> 和 <code>test_3</code>，则生成的逻辑表名为 <code>test</code>。逻辑表表达式为 <code>test_[0-3]</code>。具体请参见 <a href="[../../3.develop/4.replace-data-of-mysql-mode.md](https://help.aliyun.com/zh/dms/expressions-of-logical-tables?spm=a2c4g.11186623.0.0.7ff81ab7ToZrqX)">逻辑表表达式</a>。</li></ul>
   </main>

3. 逻辑表配置完成后，您可以对逻辑表配置分片策略，ODC 会根据您配置的分片策略进行条件定位查询，以快速查询指定物理表，免去人为计算、切换物理库表的操作。

   <main id="notice" type='explain'>
     <h4>说明</h4>
     <p>若未配置分片策略，则在对逻辑表的数据进行操作时，会遍历逻辑表对应的每一个物理表，整体操作时间会成倍增加，并且不能执行 INSERT 语句，因为此时不能确定应该去哪个物理表上执行。</p>
   </main>

   分片策略由路由 **字段+算法** 组成。您输入字段值后，ODC 会通过算法计算出物理表名。例如：

   - 简单取模：`#user_id#%100`，字段 `user_id`，算法 `mod 100`，得出来的结果范围是 `0-99`，即逻辑表的后缀。

   - 库名和表名：`'schema_prefix_'+(#user_id#%100)+'.table_name_prefix_'+(#user_id#%1000)`。

## 注意事项

- 只支持对 UPDATE 和 DELETE 变更语句自动生成回滚语句。

- 支持的变更影响行数上限为 100W，超过则不支持自动生成回滚语句。

- 若表中包含大字段，不支持自动生成回滚语句。

- OceanBase MySQL、MySQL 数据源下，若表中无主键或者唯一键，不支持自动生成回滚语句。

- UPDATE 语句的修改字段（Set）和条件字段（Where）相同，不支持自动生成回滚语句。

- 最大支持生成的自动回滚语句脚本大小为 256MB。

## 新建数据库变更任务

1. 在 **项目**/**工单** 中，单击 **逻辑库变更**。

   - 通过项目入口创建逻辑库变更。

     <img src="https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/odc/432/700.database-change-management/620.logical-database-change/1.png" width="900">

   - 通过工单入口创建逻辑库变更。

     <img src="https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/odc/432/700.database-change-management/620.logical-database-change/2.png" width="900">

2. 在 **新建数据库变更** 页面中，输入以下信息。

   <img src="https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/odc/432/700.database-change-management/620.logical-database-change/3.png" width="900">

   |  信息项   |说明|
   |--------|-------|
   | 逻辑库    | 选择需变更的逻辑库。|
   | SQL 内容 | 选择 **SQL 录入**：SQL 录入为默认方式，可在编辑区中直接录入 SQL 脚本。<main id="notice" type='explain'><h4>说明</h4><ul><li>在 SQL 录入中，最大允许输入 500000 个字符，如超限可上传附件。</li><li>单击 <strong>IN 值转化</strong> 按钮，可将批量复制的数据转化成 in（'A','B'）格式。</li><li>列值分隔符号为换行符。</li><li>行值分隔符为空格或 TAB 值。</li></ul></main>|
   | 分隔符    | 支持 delimiter 分隔符号。|
   |任务设置|选择 **立即执行** / **定时执行** 设置任务执行方式。|
   | 执行超时时间 | 在 **执行超时时间** 文本框中输入数字指定语句执行超时时间，单位为小时（默认超时时间为 48 小时，最大不超过 480 小时）。|
   | 描述   | 可在 **任务描述** 文本框中输入不超过 200 个字符的描述信息，该项为选填项。|                                                    
3. 单击 **新建**，完成新建逻辑库变更。

4. 任务生成后可以在 **工单** > **逻辑库变更** 列表中查看任务信息。
    
    <img src="4" width="900">

## 查看逻辑库变更任务

### 任务信息 

1. 如上图所示，在 **工单** 的逻辑库变更列表中，单击操作项下的 **查看** 按钮。

2. 在弹出的任务详情面板中，单击 **任务信息** 页签查看所属逻辑库、任务类型、风险等级、SQL 内容等信息。

   <img src="5" width="900">

3. 单击 **再次发起**，可重新发起逻辑库变更任务。

### 任务流程 

<img src="6" width="900">

在任务详情面板中，单击 **任务流程** 页签查看发起任务状态、审批状态、执行状态和执行结果等信息。


### 执行记录 

<img src="7" width="900">

在任务详情面板中，单击 **执行记录** 页签查看任务执行状态。

### 任务日志 

<img src="8" width="900">

在任务详情面板中，单击 **任务日志** 页签查看任务的全部日志和告警日志。


| 信息项  |  说明  |
|---------|--------------|
| 全部日志 | 全部日志显示任务的 **INFO** 、 **ERROR** 和 **WARN** 日志等全量信息。 单击 **查找** 、 **下载** 和 **复制** 按钮，可查找信息、下载或复制全部日志信息。        |
| 告警日志 | 告警日志单独显示任务的 **ERROR** 和 **WARN** 日志。当任务失败时，可通过告警日志查看错误信息。 单击 **查找** 、 **下载** 和 **复制** 按钮，可查找信息、下载或复制告警日志信息。 |

## 相关文档

- [SQL 编辑和执行](../500.sql-development/100.sql-editing-and-execution.md)

- [PL 编译和调试](../500.sql-development/200.pl-compile-and-debug.md)

- [命令行窗口](../500.sql-development/300.command-line-window.md)

- [结果编辑与导出](../500.sql-development/400.result-editing-and-exporting.md)

- [执行分析](../500.sql-development/500.perform-analysis.md)

- [生成测试数据](../500.sql-development/600.data-mocking.md)

- [分区管理](../800.data-Lifecycle-management/300.partition-scheme-management/310.manage-partition-scheme.md)

- [影子表同步](../700.database-change-management/800.shadow-table-synchronization.md)

- [无锁结构变更](../700.database-change-management/700.table-structure-change.md)
