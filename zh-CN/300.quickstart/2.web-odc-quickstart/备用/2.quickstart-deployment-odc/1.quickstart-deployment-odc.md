# 部署单节点 Web 版 ODC

## 背景信息

部署单节点 Web 版 ODC 即只部署一个 ODC 应用节点，用户所有的请求都将由该节点的 ODC 应用进行处理。用户只需在服务器上加载和运行 ODC 镜像，即可安装 ODC 应用。

浏览器通过 HTTP 协议访问 Web 版 ODC，因此首次通过浏览器访问 Web 版 ODC 时，会收到连接不安全的警告信息。可参考高可用部署的步骤在单节点 ODC 服务器上配置 SSL 证书并部署 Nginx 镜像，以安全访问 ODC。

<main id="notice" type='explain'>
   <h4>说明</h4>
   <p>Web ODC 管理员的初始用户名为 admin，在部署 Web ODC 时可以通过环境变量 <code>ODC_ADMIN_INITIAL_PASSWORD</code>设置 ODC 管理员账号的初始密码。具体配置请参考 加载和运行 ODC 镜像</a>。</p>
</main> 
  
## 前提条件

部署 Web ODC 前需要准备元数据库和机器环境，部署完成后请在谷歌浏览器 Chrome 中访问 Web 版 ODC。

### 元数据库

元数据库用于存储用户使用 ODC 过程中新建的数据源和脚本等操作产生的用户数据，安装 Web 版 ODC 前需要准备元数据库（OceanBase MySQL 模式）；桌面版的元数据库为本地数据库，首次使用时会自动创建，所以无需手动准备元数据库。

1. 在 OceanBase MySQL 模式下申请一个租户。租户大小为 2C8G，租户名称无限制。示例：租户所在的集群名称为 `odc_cluster`，租户名称为 `odc_tenant`。
     
   <main id="notice" type='explain'>
      <h4>说明</h4>
      <ul>
      <li>ODC V3.3.0 之后的版本提供变更流程和操作审计等企业级管控能力。</li>
      <li>ODC V3.3.1 之后的版本解除对 MetaDB 版本的限制。</li>
      <li>MetaDB 所在的 OceanBase 租户规格推荐 2C8G 及以上配置，配置过低容易导致性能问题。</li>
      </ul>
   </main> 

2. 在租户下创建数据库和用户以作为 ODC 元数据库，用户名、密码和元数据库名称无限制。示例：数据库命名为 `odc_metadb`，数据库用户名和密码均为 `obodc`。

3. 记录元数据库的名称、用户名、密码、租户名称和租户所在的集群名称，在部署 ODC 时此类信息需要作为参数传入。

### 机器环境

单节点 Web 版 ODC 部署环境配置，按照 ODC 用户数量的经验值：

| ODC 用户数量 | 服务器类型|服务器数量|功能最低配置|性能最低配置|
| ------------- |-------------   |-------------|-------------|-------------|
| 20  |  ODC Docker 部署服务器 |1 台，可复用 OCP 管控服务器|2C，8GB 内存|4C，16GB 内存|

更多用户视使用情况调整资源。

<main id="notice" type='explain'>
   <h4>说明</h4>
   <ul>
   <li>实际资源消耗取决于并发用户数量和用户使用的功能，表格中的配置是供参考的经验值。</li>
   <li>如果需要 Web 版 ODC 提供高可用能力，则需要部署多台服务器。具体请参考 <a href="4.deploy-the-ha-odc/1.ha-odc-deployment-process.md">部署高可用 ODC</a>。</li>
   <li>为实现轻量化的部署，ODC 使用了容器镜像，因此在部署前请在机器上安装 Docker 以拉取和运行镜像。</li>
   </ul>
</main>

### 浏览器

推荐使用谷歌浏览器 Chrome 访问 Web 版 ODC，支持 78 及以上版本。

### 配置白名单

ODC V3.3.1 之后的版本支持配置数据库白名单，防止 SSRF 攻击。

部署管理员连接到 ODC 的 MetaDB 后，访问该连接并执行 ``UPDATE config_system_configuration SET `value`='x.x.x.x' WHERE `key` = 'odc.connect.host-white-list';`` 配置白名单。（多个 IP 使用逗号分隔，但不支持指定网段）

### 安装与启动 Docker

有关安装与启动 Docker，请参见 [绑定挂载](https://docs.docker.com/storage/bind-mounts/)。

## 操作步骤

完成 OceanBase 开发者中心（OceanBase Developer Center，ODC）元数据库的初始化后，需拉取和运行 ODC 镜像。镜像运行成功后，即可完成 ODC 的单节点部署。

### 步骤一：加载镜像

1. 在宿主机上获取 ODC 镜像，单击 **\[下载\]** 以获取所需的镜像架构版本：

   - X86 镜像：[\[下载\]](https://ob-front.oss-cn-hangzhou.aliyuncs.com/client/4.1.3/obodc4.1.3.tar.gz)<br>

   - ARM 镜像：[\[下载\]](https://ob-front.oss-cn-hangzhou.aliyuncs.com/client/4.1.3/obodc4.1.3_arm.tar.gz)


2. 在宿主机上获取镜像文件后，在命令行工具中运行下述语句加载镜像：

   语法格式：

   ```javascript
   gunzip -c obodc-{$version}.tar.gz | docker load
   ```

   示例：

   ```javascript
   #!/usr/bin/env bash
   docker run -v /var/log/odc:/opt/odc/log   -v /var/data/odc:/opt/odc/data \
   -d -i --net host --cpu-period 100000 --cpu-quota 400000 --memory 8G --name "obodc" \
   -e "DATABASE_HOST=xxx.xx.xx.xx" \
   -e "DATABASE_PORT=60805" \
   -e "DATABASE_USERNAME=[用户名]@[租户名称]#[集群名称]" \
   -e "DATABASE_PASSWORD=******" \
   -e "DATABASE_NAME=odc_metadb" \
   -e "ODC_PROFILE_MODE=alipay" \
   -e "ODC_ADMIN_INITIAL_PASSWORD=******" \
   reg.docker.alibaba-inc.com/oceanbase/odc-server:{image_tag}
   ```



   其中，{image_tag} 可在宿主机上加载镜像后运行 `docker images` 语句查看，其他参数说明如下表所示：


   | 参数|说明 |
   |------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
   |-v | <ul><li>宿主机的 `/var/log/odc`  目录映射到 ODC 容器内的 `/opt/odc/log` 目录。 `/var/log/odc` 为宿主机的目录，如不存在需先创建，创建目录的参考命令 `mkdir -p /var/log/odc`。</li><li>宿主机的 `/var/data/odc` 目录挂载到 ODC 容器内的 `/opt/odc/data` 目录。`/var/data/odc` 为宿主机的目录，可自定义，如不存在需先创建，创建目录的参考命令 `mkdir -p /var/data/odc`。</li></ul>|
   | --net | 指定容器的网络配置，指定该参数值为 `host` 即直接使用宿主机网络。 您也可以使用 `--publish`（`-p`）参数配置端口映射，但是部分环境可能出现因为 Docker 内 DNS 解析出错而启动容器失败，此时请使用 `--net host` 方式启动 Docker。|
   | --cpu-period --cpu-quota | <li> `---cpu-period` 用来指定容器对 CPU 的使用要在多长时间内做一次重新分配。单位：微秒。</li>   <li> `---cpu-quota` 用来指定在这个周期内，最多可以有多少时间用来运行当前容器。单位：微秒。 </li>   配合使用可指定容器使用的 CPU 核数。`cpu-quota`/`cpu-period` 的值即为 Docker 可以使用的 CPU 核数，示例语句中 400000/100000=4 表示最多可以使用 4 个核。 |
   | --memory   | 设置容器使用的内存最大值。 |
   | --name  | 指定容器名称。   |
   | DATABASE_HOST  | 元数据库 IP 地址。 |
   | DATABASE_PORT  | 元数据库端口号。 |
   | DATABASE_USERNAME | 元数据库用户名。OceanBase 数据库用户名的格式：`db_user@tenant_name#cluster_name`。  |
   | DATABASE_PASSWORD  | 连接数据库的密码。
   | DATABASE_NAME  | 元数据库名。|
   | ODC_PROFILE_MODE| 指定模式，默认指定：`alipay`。|
   | ODC_ADMIN_INITIAL_PASSWORD| 指定 ODC 管理员账号的初始密码。<blockquote>**注意**</br>设置的初始密码需要符合：至少包含 2 位数字、2 位大写字母、2 位小写字母和 2 位特殊字符（._+@#$%），长度 8~32 位，且密码中不能包含空格。</blockquote>|

   除上述参数外，运行镜像时您还可以根据需求使用下述参数：


   |   参数  | 说明 |
   |-----------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
   | ODC_LOG_DIR           | 指定日志目录。默认路径：`/opt/odc/log`。  |
   | OBCLIENT_WORK_DIR     | 指定 OBClient 工作目录。默认路径：`/opt/odc/data`。 |
   | ODC_JAR_FILE          | 指定 Jar 文件目录。默认路径：`/opt/odc/lib/odc-web-starter-*.jar`。|
   | ODC_WORK_DIR          | 指定 ODC 工作目录。默认路径：`/opt/odc/script`。 |
   | ODC_JVM_HEAP_OPTIONS  | 指定 JVM 内存配置。默认值：`-XX:MaxRAMPercentage=60.0 -XX:InitialRAMPercentage=60.0`，表示使用 60% 的的内存，可通过指定参数 `ODC_JVM_HEAP_OPTIONS` 自定义 JVM 内存配置。例如：配置为 `-Xmx2048m -Xms2048m`，表示设置堆内存为 2G。        |
   | ODC_JVM_GC_OPTIONS    | 指定 JVM GC 策略。默认指定：`-XX:+UseG1GC -XX:+PrintAdaptiveSizePolicy -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+PrintGCDateStamps -Xloggc:/opt/odc/log/gc.log -XX:+UseGCLogFileRotation -XX:GCLogFileSize=50M -XX:NumberOfGCLogFiles=5`。 |
   | ODC_JVM_OOM_OPTIONS   | 指定 JVM OutOfMemory 策略。默认指定：`-XX:+ExitOnOutOfMemoryError`。 |
   | ODC_JVM_EXTRA_OPTIONS | 指定其它需要的 JVM 配置参数。默认值：空。 |
   | ODC_SERVER_PORT       | 指定 ODC-Server 的 HTTP 监听端口。默认值：8989。|
   | ODC_HOST              | 指定 ODC 运行时的 IP 地址，该参数在高可用部署场景下做为远程过程调用的目的地址。 |
   | ODC_MAPPING_PORT             | 指定 ODC 运行时的端口号，避免因部署环境导致的端口号无法使用的问题。该参数适用于在 Docker 中部署 ODC 时进行端口映射的场景。  |
   | ODC_APP_EXTRA_ARGS    | 其它需要指定的 App 参数。<br> 例如 `--server.servlet.session.timeout=10m`，表示 Session 过期时间为 10 分钟。默认值：空。                         |
   | ODC_SERVER_RPC_PORT    | 指定 ODC-Server 的内部 RPC 通信监听端口。默认值：8990。                         |

