# ODC V4.2.0

<main id="notice" type='notice'>
   <h4>注意</h4>
   <p>从低版本升级到 ODC V4.2.0 版本前，请务必阅读本篇文档中的 <strong>升级注意事项</strong> 内容。</p>
</main>

本次 8 月发版的 OceanBase 开发者中心（OceanBase Developer Center，ODC）V4.2.0 版本旨在提升您对数据库变更管理的控制能力，以减少变更风险。
在该版本中，我们引入了基于项目的管理能力，让您可以以项目为单位进行数据库、成员和工单的管理。通过这种方式，您可以更好地组织和跟踪数据库变更，提高团队的协作效率。
此外，我们还为您提供了全新的 SQL 检查功能。该功能可以帮助您检查和评估变更请求，以确保变更的合规性和安全性。您可以通过运行 SQL 检查，及时发现潜在的问题，并在变更前进行必要的调整，降低变更引起的风险。
为了保护您的敏感数据安全，我们还增加了数据脱敏功能。通过该功能，您可以对敏感数据进行处理，以保护用户隐私和遵守数据安全规范。
我们还提供了数据清理和数据归档的功能，以帮助您优化数据库的存储和管理。您可以根据数据的使用频率和重要性，将数据进行分离和清理，以提高数据库的性能和效率。
最后，为了确保生产系统的稳定性，我们在公有云上提供了无锁结构变更能力。通过数据同步、数据校验和切流等关键步骤，我们可以实现低业务影响的结构变更，让您的业务持续运行，减少停机时间。
除了以上功能改进，我们还注重提升您的使用体验。在该版本中，我们进行了系统集成产品化，增强了 PL 调试能力，并优化了 SQL 控制台的布局，以提供更好的用户体验。

## 版本信息 

* **当前版本：** V4.2.0

* **前置版本：** V4.1.3

* **发版时间：** 2023 年 08 月 18 日

* **支持的升级路径：** 对于 ODC V2.0.0 及之后版本，均可直接升级至本版本。

## 支持的 OceanBase 数据库版本

OceanBase 开发者中心 V4.2.0 版本支持下述版本的 OceanBase 数据库。

* ODC 通用功能支持 OceanBase 数据库版本

  * OceanBase V1.4.x（主流版 V1.4.7）
  
  * OceanBase V2.0.x
  
  * OceanBase V2.1.x
  
  * OceanBase V2.2.x（主流版 V2.2.7）
  
  * OceanBase V3.1.x（主流版 V3.1.2）
  
  * OceanBase V3.2.x（主流版 V3.2.4）

  * OceanBase V4.0.0

  * OceanBase V4.1.0
  
  * OceanBase 社区版

* ODC PL 功能支持 OceanBase 数据库版本

  * PL 对象（函数/存储过程/程序包）编译、PL 对象（函数/存储过程）调试和匿名块调试：支持 V2.2.7、V3.0.x 及之后版本，推荐 OceanBase V3.2.3 BP4 及之后版本体验更友好的调试能力。
  
  * PL 对象（函数/存储过程/程序包）运行和匿名块运行：支持 V2.0.x 及之后版本。

## 功能变更

* 变更管控

  * 上线了基于项目的管控：在团队空间，所有流程的运转均以项目为中心进行。拥有项目资源管理权限的用户才可允许新建项目，新建项目时须指定项目角色对应的成员。项目角色分为：项目管理员、项目 DBA 及普通成员，项目成员角色可以应用在审批流节点配置中。平台默认对项目成员开放项目内数据库的查询权限，若需要进行变更操作需要发起对应工单。

  * 支持 SQL 检查：在团队空间，每个环境都有一套独立的 SQL 检查规则，本迭代内置了 45 条规则，配置者可以自行调整检查规则细节（是否启用、允许值、改进级别等），SQL 检查会应用在 SQL 窗口及数据库变更工单中。
  
  * 支持数据库变更流程自动生成回滚语句：支持根据自动生成的回滚语句发起数据库变更单。

* 安全合规

  * 支持动态脱敏：项目owner 可对本项目内的数据进行敏感配置，保证敏感数据被访问（SQL 查询、导出）时是脱敏状态。

  * 操作审计内容完善：动态脱敏、无锁结构变更、数据清理、数据归档功能纳入审计。

* 数据生命周期

  * 上线数据清理功能：您可以定期清理掉业务表中的过期数据，实现在线库的瘦身。

  * 上线数据归档功能：通过数据归档，您可以配置灵活的归档条件，实现冷热数据分离。

* 稳定变更

  * 公有云上支持无锁结构变更：依赖 OMS 服务，通过 OMS 提供的全量数据迁移、增量同步及数据校验能力实现低业务影响的结构变更。

* 执行分析

  * 提供 SQL 执行视角下的全链路诊断功能：OceanBase V4.0.0 及之后的版本支持在查询结果的「计划」中查看全链路 TRACE 信息。

* 部署及登录

  * 登录时密码输入错误超上限，提示信息中增加下次可重试时间（提示：10 分钟后重试）。

* SQL Console

  * SQL Console 全面升级。

* SQL 执行

  * 结果集根据查询会话的 `nls_date_format` 参数值展示日期值。

  * 解决 OceanBase Oracle 模式下，浮点型数据显示问题（小于 1 时小数点前补 0）。

  * SQL 窗口增加右键粘贴功能（注意：需要在安全的网络访问环境 /https 下操作，否则剪切板能力会被禁用）。

* PL 生命周期

  * PL 调试入参交互全面升级，支持指定当前时间等作为入参。

  * PL 支持查看 `sys_refcursor` 返回值内容。

* 数据生成与迁移

  * 导入兼容从外部工具 pl/sql developer 导出的文件(如为单个文件，删除文件中的注释，并定义 delimiter 符号；如为多个文件，将文件合成为 OBLOADER 能识别的文件目录）。

  * 查看导出任务，导出对象下线 **计划处理数量** 指标。

  * OceanBase MySQL 模式下，支持 SEQUENCE 对象导出。

* 数据库对象

  * OceanBase Oracle 模式下，解决表对象编辑页面外键禁用不生效问题。

  * 创建表时字段默认值增加 `NULL` 选项。

* 访问权限

  * 支持聚石塔账号集成识别管理员身份。

* 错误消息

  * 报错提示中补充 `requestId`、`request url` 等辅助信息。

* 系统集成

  * 支持 SSO 集成产品化。

  * 支持外部审批系统集成产品化。

  * 支持外部 SQL 审核系统集成产品化。

## 功能限制

* 数据归档

  * 数据源必须配置集群实例（集群名称）。

  * 数据源必须通过 proxy 连接（不支持直连 OceanBase）。

  * 非阿里云公有云环境必须配置 sys 租户账号。

  * OceanBase V4.1.0 版本不支持数据归档。

  * 只支持 OceanBase MySQL 模式数据归档。

  * 只支持主键 PRIMARY KEY 的表进行归档。
  
  * BIT、enum、set 数据类型不支持数据归档。
  
  * 条件中包含 limit 类型不支持数据归档。
  
  * 拥有外键的表不支持数据归档。

* 自动生成回滚语句

  * 只支持对 UPDATE 和 DELETE 语句生成回滚。

  * OceanBase MySQL 模式下，无主键或者唯一键的表进行 UPDATE/DELETE 时不支持生成对应回滚 SQL。

  * 不支持对包含大字段的变更表生成回滚 SQL。
  
  * 生成备份回滚方案支持的数据库变更任务总的变更行数为 100W，超过此变更行数生成备份回滚方案失败。
  
  * 生成的备份回滚方案文件大小不超过 256MB，与数据库变更任务支持上传的最大 SQL 脚本大小
  
  * OceanBase oracle 模式下，执行 UPDATE 且 UPDATE SET 和 WHERE 的字段相同时生成的删除语句执行失败。

* 动态脱敏

  * Groovy 只允许用户使用 Java 中的 Objects 类 和 Stirng 类。
  
  * 不支持 Groovy 闭包、自带的闭包函数等。

* SSO 集成

  * 只支持授权码模式。
  
  * 退出登录只清除 ODC 应用的登录态。不会清理 SSO 系统的登录态。
  
  * 映射名称必须为字符串 String 类型。

## 升级注意事项

* 数据源

  * 连接配置概念调整为数据源。

  * ODC V4.2.0 暂不支持新建 ODP 数据源，后续版本恢复。

  * 个人连接迁移到个人空间，以数据源的形式存在。

  * 公共连接迁移到团队空间，以数据源的形式存在。

  * 原公共连接中的只读、读写账号，升级后仅保留读写账号。

* 用户权限

  * 下线 private_connection/apply_connection 角色，升级到 ODC V4.2.0 版本的用户引用的 private_connection/apply_connection 角色对应的权限不再生效。

  * 下线资源组。

  * 下线连接访问权限，ODC V4.2.0 中通过项目管控实现对数据库的访问控制。

* 系统设置

  * ODC V4.2.0 版本中已下线。

* 工单模块

  * 历史工单仅允许查看用户自己发起的工单。

* 分区计划

  * ODC V4.2.0 暂不支持，后续版本恢复。

  * 升级到 ODC V4.2.0 版本后，历史分区计划任务将停止运行。

* SQL 计划

  * 升级到 ODC V4.2.0 版本后，历史 SQL 计划任务将停止运行。

* 任务流程

  * 该功能模块在 ODC V4.2.0 中下线，已上线风险等级模块实现对应效果。

* 数据脱敏

  * 该功能已在 ODC V4.2.0 中升级，历史数据脱敏配置不再生效。

* 堡垒机集成

  * 该功能在 ODC V4.2.0 中暂不可用，后续版本恢复。

* 历史会话

  * 下线历史会话，ODC V4.2.0 中默认会保存 SQL 窗口的使用状态。

## 问题修复

* 数据库变更

  * 数据库变更任务包含耗时语句时，数据库变更任务终止没有取消对应的 SQL 执行。

  * 多节点部署时，数据库变更下载查询结果可能执行失败。

* SQL 执行

  * OceanBase Oracle 模式下，表名是关键字时 select 带别名列的自动补全不可用。

  * 格式化时，`=>` 中间会自动加空格。

  * OceanBase Oracle 模式下，执行 `CREATE USER xxx IDENTIFIED BY "";` 分句失败。

    * binary number 列包含 Nan 或 Inf 时，查询报错。

* PL 对象

  * 程序包子程序包含 `a mod b` 复合表达式时解析失败。

* 表

  * 上传大对象失败，报错可读性差。

  * OceanBase Oracle 模式下，编辑表数据无法生成 UPDATE 语句。

* 桌面版

  * Java 9 之后的版本未给出对应错误信息，报错 Java 进程异常退出。

  * 启动桌面版时长时间未反应。

* 安全加固

  * 修复 OSS 文件遍历风险。

## 已知问题

* 客户端版 ODC 不支持安装在中文目录名中。

* 导出包含虚拟列的表时，导出的数据文件和内容显示异常。

* Web 版 ODC 中，结构或数据的导入量上限为 2GB，超限文件无法上传。

* Web 版 ODC 中，结构或数据的导出量上限为 2GB，超限会导致最终导出数据不完整。

* 导出任务详情中，导出对象的数据总记录数依赖 OceanBase 数据库视图，并非精准值。

* 需设置 `ob_enable_trace_log` 参数为 `on`，否则只显示首次执行的 SQL 的执行计划。

## 相关文档

- [开源版 ODC](https://github.com/oceanbase/odc)

- [企业版 ODC](https://www.oceanbase.com/product/odc)